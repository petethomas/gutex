<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gutex - Project Gutenberg Reader</title>

  <!-- Privacy-friendly analytics by Plausible -->
  <script async src="https://plausible.io/js/pa-vnjNSDGjn2um_Ck72v_qw.js"></script>
  <script>
    window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
    plausible.init()
  </script>

  <style>
    :root {
      --bg-primary: #fff;
      --bg-secondary: #f8f8f8;
      --text-primary: #000;
      --text-secondary: #666;
      --text-muted: #999;
      --border-color: #000;
      --border-light: #eee;
      --btn-bg: #000;
      --btn-text: #fff;
      --btn-hover: #333;
      --input-bg: #fff;
      --input-border: #000;
      --accent-color: #3b82f6;
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2a2a2a;
      --text-primary: #e0e0e0;
      --text-secondary: #999;
      --text-muted: #666;
      --border-color: #444;
      --border-light: #333;
      --btn-bg: #444;
      --btn-text: #fff;
      --btn-hover: #555;
      --input-bg: #2a2a2a;
      --input-border: #555;
      --accent-color: #60a5fa;
    }

    [data-theme="scifi"] {
      --bg-primary: #0d0d1a;
      --bg-secondary: #1a1a2e;
      --text-primary: #00ffff;
      --text-secondary: #0099cc;
      --text-muted: #006688;
      --border-color: #00ffff;
      --border-light: #1a3a4a;
      --btn-bg: #00ffff;
      --btn-text: #0d0d1a;
      --btn-hover: #00cccc;
      --input-bg: #1a1a2e;
      --input-border: #00ffff;
      --accent-color: #ff00ff;
    }

    [data-theme="greenfield"] {
      --bg-primary: #f0f5f1;
      --bg-secondary: #e0ebe3;
      --text-primary: #2d4a32;
      --text-secondary: #5a7a5f;
      --text-muted: #8aa08f;
      --border-color: #5a7a5f;
      --border-light: #c5d5c8;
      --btn-bg: #3d6a45;
      --btn-text: #fff;
      --btn-hover: #4d7a55;
      --input-bg: #fff;
      --input-border: #5a7a5f;
      --accent-color: #4ade80;
    }

    [data-theme="stoneworks"] {
      --bg-primary: #262626;
      --bg-secondary: #333;
      --text-primary: #d4d4d4;
      --text-secondary: #a0a0a0;
      --text-muted: #707070;
      --border-color: #555;
      --border-light: #404040;
      --btn-bg: #555;
      --btn-text: #fff;
      --btn-hover: #666;
      --input-bg: #333;
      --input-border: #555;
      --accent-color: #a0a0a0;
    }

    [data-theme="redbrick"] {
      --bg-primary: #faf6f2;
      --bg-secondary: #f0e8e0;
      --text-primary: #5c3d2e;
      --text-secondary: #8b5a3c;
      --text-muted: #b08060;
      --border-color: #8b5a3c;
      --border-light: #e0d0c0;
      --btn-bg: #8b4513;
      --btn-text: #fff;
      --btn-hover: #a05520;
      --input-bg: #fff;
      --input-border: #8b5a3c;
      --accent-color: #cd853f;
    }

    [data-theme="midnight"] {
      --bg-primary: #0f1628;
      --bg-secondary: #1a2540;
      --text-primary: #c0d0e8;
      --text-secondary: #8090a8;
      --text-muted: #506080;
      --border-color: #3050a0;
      --border-light: #253050;
      --btn-bg: #3050a0;
      --btn-text: #fff;
      --btn-hover: #4060b0;
      --input-bg: #1a2540;
      --input-border: #3050a0;
      --accent-color: #60a0ff;
    }

    [data-theme="amber"] {
      --bg-primary: #1a1408;
      --bg-secondary: #2a2010;
      --text-primary: #ffc860;
      --text-secondary: #c09030;
      --text-muted: #806020;
      --border-color: #c09030;
      --border-light: #3a3018;
      --btn-bg: #c08020;
      --btn-text: #1a1408;
      --btn-hover: #d09030;
      --input-bg: #2a2010;
      --input-border: #c09030;
      --accent-color: #ffc860;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: Georgia, 'Times New Roman', serif;
      font-size: 18px;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    
    .container {
      max-width: 600px;
      width: 100%;
    }
    
    h1 {
      font-size: 48px;
      font-weight: normal;
      margin-bottom: 8px;
      letter-spacing: -1px;
    }
    
    .tagline {
      color: var(--text-secondary);
      margin-bottom: 40px;
    }
    
    .tagline a {
      color: var(--accent-color);
      text-decoration: none;
    }
    .tagline a:hover {
      text-decoration: underline;
    }
    
    .hint-toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--btn-bg);
      color: var(--btn-text);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 9999;
    }
    
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
    }
    
    .search-box input {
      flex: 1;
      padding: 12px 16px;
      font-size: 18px;
      font-family: inherit;
      border: 2px solid var(--border-color);
      border-radius: 4px;
      outline: none;
      background: var(--input-bg);
      color: var(--text-primary);
    }
    
    .search-box input::placeholder {
      color: var(--text-muted);
    }
    
    .search-box input:focus {
      border-color: var(--text-secondary);
    }
    
    .search-box button {
      padding: 12px 24px;
      font-size: 16px;
      font-family: monospace;
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .search-box button:hover {
      background: var(--btn-hover);
    }

    .lang-select {
      padding: 10px 12px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 4px;
      background: var(--input-bg);
      color: var(--text-primary);
      cursor: pointer;
      outline: none;
    }
    .lang-select:focus {
      border-color: var(--text-secondary);
    }
    
    .results {
      list-style: none;
    }
    
    .results li {
      padding: 16px 0;
      border-bottom: 1px solid var(--border-light);
    }
    
    .results li:last-child {
      border-bottom: none;
    }
    
    .results li.selected {
      background: var(--bg-secondary);
      margin: 0 -16px;
      padding: 16px;
      border-radius: 4px;
    }
    
    .results a {
      color: var(--text-primary);
      text-decoration: none;
      display: block;
    }
    
    .results a:hover {
      color: var(--text-secondary);
    }
    
    .results .book-id {
      font-family: monospace;
      font-size: 14px;
      color: var(--text-muted);
      margin-right: 8px;
    }
    
    .results .book-title {
      font-size: 18px;
    }
    
    .results .book-author {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .status {
      color: var(--text-secondary);
      font-style: italic;
      padding: 20px 0;
    }
    
    .popular {
      margin-top: 40px;
      padding-top: 40px;
      border-top: 1px solid var(--border-light);
    }
    
    .popular h2 {
      font-size: 16px;
      font-weight: normal;
      color: var(--text-secondary);
      margin-bottom: 16px;
      font-family: monospace;
    }
    
    .popular-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .popular-grid a {
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 4px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 14px;
    }
    
    .popular-grid a:hover {
      background: var(--border-light);
    }
    
    .popular-grid .id {
      font-family: monospace;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Room Banner - shown when in a room */
    .room-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #3b82f6;
      color: #fff;
      padding: 10px 20px;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 16px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .room-banner.visible { display: flex; }
    .room-banner .room-code {
      font-family: monospace;
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 2px;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 4px;
    }
    .room-banner .room-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .room-banner .peer-count {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    .room-banner button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-family: monospace;
    }
    .room-banner button:hover { background: rgba(255,255,255,0.3); }
    .room-banner .copy-btn { margin-left: -8px; }
    .room-banner .leave-btn { background: rgba(0,0,0,0.2); }
    .room-banner .leave-btn:hover { background: rgba(0,0,0,0.3); }

    body.in-room { padding-top: 100px; }

    /* P2P Toggle Button */
    .p2p-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      opacity: 0.7;
      transition: all 0.2s;
      z-index: 1000;
    }
    .p2p-toggle:hover { opacity: 1; }
    .p2p-toggle.connected { background: #4ade80; border-color: #22c55e; opacity: 1; }
    body.in-room .p2p-toggle { display: none; }

    /* P2P Panel */
    .p2p-panel {
      position: fixed;
      bottom: 80px;
      left: 20px;
      width: 320px;
      max-height: 70vh;
      background: var(--bg-primary);
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
      display: none;
      flex-direction: column;
      z-index: 1001;
      overflow: hidden;
      border: 1px solid var(--border-light);
    }
    .p2p-panel.visible { display: flex; }
    body.in-room .p2p-panel { display: none !important; }

    .p2p-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
    }
    .p2p-header h3 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .p2p-header button { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.5; color: var(--text-primary); }
    .p2p-header button:hover { opacity: 1; }

    .p2p-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      font-size: 13px;
      font-family: monospace;
      color: var(--text-secondary);
    }
    .p2p-status .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    .p2p-status .status-dot.connected { background: #22c55e; }

    .p2p-content {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    .p2p-section {
      margin-bottom: 16px;
    }
    .p2p-section:last-child { margin-bottom: 0; }
    .p2p-section h4 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-family: monospace;
    }

    .p2p-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .p2p-input-group input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      background: var(--input-bg);
      color: var(--text-primary);
    }
    .p2p-input-group input::placeholder { color: var(--text-muted); }
    .p2p-input-group input:focus { border-color: var(--accent-color); outline: none; }
    .p2p-input-group button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-family: monospace;
    }
    .p2p-btn-primary { background: var(--btn-bg); color: var(--btn-text); }
    .p2p-btn-primary:hover { background: var(--btn-hover); }
    .p2p-btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color) !important; }
    .p2p-btn-secondary:hover { background: var(--border-light); }

    /* Peer activity display */
    .peer-activity {
      margin-top: 24px;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      display: none;
    }
    .peer-activity.visible { display: block; }
    .peer-activity .peer-header {
      font-size: 12px;
      font-family: monospace;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .peer-activity .typing-indicator {
      display: inline-flex;
      gap: 2px;
    }
    .peer-activity .typing-indicator span {
      width: 4px;
      height: 4px;
      background: var(--accent-color);
      border-radius: 50%;
      animation: typing-bounce 1.4s infinite ease-in-out;
    }
    .peer-activity .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .peer-activity .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .peer-activity .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing-bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-4px); }
    }
    .peer-activity .activity-content {
      font-size: 14px;
      color: var(--text-primary);
    }
    .peer-activity .search-query {
      font-style: italic;
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 4px;
      border-left: 3px solid var(--accent-color);
      margin-bottom: 8px;
    }
    .peer-activity .search-results {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .peer-activity .result-item {
      padding: 6px 0;
      border-bottom: 1px solid var(--border-light);
    }
    .peer-activity .result-item:last-child { border-bottom: none; }
    .peer-activity .result-item a {
      color: var(--accent-color);
      text-decoration: none;
    }
    .peer-activity .result-item a:hover { text-decoration: underline; }
    .peer-activity .reading-info {
      padding: 8px 12px;
      background: var(--bg-primary);
      border-radius: 4px;
      border-left: 3px solid #22c55e;
    }
    .peer-activity .reading-info .book-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .peer-activity .reading-info .progress {
      font-size: 12px;
      color: var(--text-secondary);
    }

    @media (max-width: 480px) {
      .p2p-panel {
        width: calc(100vw - 32px);
        left: 16px;
        bottom: 80px;
        max-height: 50vh;
      }
      .p2p-toggle {
        bottom: 16px;
        left: 16px;
        width: 40px;
        height: 40px;
      }
      .room-banner {
        flex-wrap: wrap;
        gap: 8px;
        padding: 8px 12px;
      }
    }

    .site-footer {
      position: fixed;
      bottom: 8px;
      right: 12px;
      z-index: 50;
    }
    .site-footer a {
      color: var(--text-muted);
      opacity: 0.5;
      transition: opacity 0.15s;
    }
    .site-footer a:hover {
      opacity: 1;
    }

    /* ========== Mobile Hardening ========== */
    /* Prevent touch zoom and long-press context menus */
    button, a, input, select {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    /* Prevent pull-to-refresh */
    html {
      overscroll-behavior: none;
    }

    @media (max-width: 768px), (pointer: coarse) {
      /* Prevent body scrolling issues */
      html, body {
        overflow-x: hidden;
        overscroll-behavior: none;
      }

      /* Larger touch targets for search results */
      .results li {
        min-height: 48px;
        padding: 16px 8px;
      }

      .results a {
        padding: 8px 0;
      }

      /* Larger touch targets for popular grid */
      .popular-grid a {
        min-height: 48px;
        padding: 16px;
      }

      /* Ensure buttons are easily tappable */
      button {
        min-height: 44px;
        user-select: none;
        -webkit-user-select: none;
      }

      /* Fix P2P panel on mobile */
      .p2p-panel {
        width: calc(100vw - 40px);
        left: 20px;
        max-height: 60vh;
      }
    }
  </style>
</head>
<body>
  <!-- Room Banner - always visible when in room -->
  <div class="room-banner" id="roomBanner">
    <div class="room-info">
      <span>Room:</span>
      <span class="room-code" id="bannerRoomCode"></span>
      <button class="copy-btn" id="bannerCopyBtn">Copy</button>
    </div>
    <span class="peer-count" id="bannerPeerCount">1 person</span>
    <button class="leave-btn" id="bannerLeaveBtn">Leave</button>
  </div>

  <div class="container">
    <h1>Gutex</h1>
    <p class="tagline">Navigate <a href="https://gutenberg.org" target="_blank">Project Gutenberg</a> eBooks</p>
    
    <div class="search-box">
      <input type="text" id="query" placeholder="Search by title or author..." autofocus>
      <select id="langSelect" class="lang-select" title="Search language">
        <option value="en" title="English">üá¨üáß EN</option>
        <option value="de" title="German">üá©üá™ DE</option>
        <option value="fr" title="French">üá´üá∑ FR</option>
        <option value="es" title="Spanish">üá™üá∏ ES</option>
        <option value="it" title="Italian">üáÆüáπ IT</option>
        <option value="pt" title="Portuguese">üáµüáπ PT</option>
        <option value="nl" title="Dutch">üá≥üá± NL</option>
        <option value="fi" title="Finnish">üá´üáÆ FI</option>
        <option value="zh" title="Chinese">üá®üá≥ ZH</option>
        <option value="ja" title="Japanese">üáØüáµ JA</option>
        <option value="la" title="Latin">üèõÔ∏è LA</option>
        <option value="el" title="Greek">üá¨üá∑ EL</option>
        <option value="all" title="All Languages">üåç All</option>
      </select>
      <button id="searchBtn">Search</button>
    </div>
    
    <div id="status"></div>
    <ul class="results" id="results"></ul>

    <!-- Peer activity display -->
    <div class="peer-activity" id="peerActivity">
      <div class="peer-header">
        <span id="peerActivityName"></span>
        <span class="typing-indicator" id="typingIndicator" style="display: none;">
          <span></span><span></span><span></span>
        </span>
      </div>
      <div class="activity-content" id="peerActivityContent"></div>
    </div>
    
    <div class="popular">
      <h2>Popular Books</h2>
      <div class="popular-grid">
        <a href="/read#1342"><span class="id">#1342</span> Pride and Prejudice</a>
        <a href="/read#11"><span class="id">#11</span> Alice in Wonderland</a>
        <a href="/read#1661"><span class="id">#1661</span> Sherlock Holmes</a>
        <a href="/read#84"><span class="id">#84</span> Frankenstein</a>
        <a href="/read#345"><span class="id">#345</span> Dracula</a>
        <a href="/read#2701"><span class="id">#2701</span> Moby Dick</a>
        <a href="/read#174"><span class="id">#174</span> Dorian Gray</a>
        <a href="/read#98"><span class="id">#98</span> Tale of Two Cities</a>
        <a href="/read#1232"><span class="id">#1232</span> The Prince</a>
        <a href="/read#996"><span class="id">#996</span> Don Quixote</a>
        <a href="/read#6920"><span class="id">#6920</span> Meditations</a>
        <a href="/read#1952"><span class="id">#1952</span> Yellow Wallpaper</a>
      </div>
    </div>
  </div>

  <!-- P2P Toggle Button -->
  <button class="p2p-toggle" id="p2pToggle" title="Join a Room">üë•</button>

  <!-- P2P Panel -->
  <div class="p2p-panel" id="p2pPanel">
    <div class="p2p-header">
      <h3>Join a Room</h3>
      <button id="p2pClose">‚úï</button>
    </div>
    <div class="p2p-status">
      <span class="status-dot" id="p2pStatusDot"></span>
      <span id="p2pStatusText">Connecting...</span>
    </div>
    <div class="p2p-content">
      <!-- Display Name -->
      <div class="p2p-section">
        <h4>Your Name</h4>
        <div class="p2p-input-group">
          <input type="text" id="p2pDisplayName" placeholder="Enter your name...">
        </div>
      </div>

      <!-- Join Room -->
      <div class="p2p-section">
        <h4>Join a Room</h4>
        <div class="p2p-input-group">
          <input type="text" id="p2pRoomCodeInput" placeholder="Room code..." maxlength="6" style="text-transform: uppercase; font-family: monospace;">
          <button class="p2p-btn-primary" id="p2pJoinBtn">Join</button>
        </div>
      </div>

      <!-- Create Room -->
      <div class="p2p-section">
        <h4>Or Start a New Room</h4>
        <div class="p2p-input-group">
          <button class="p2p-btn-secondary" id="p2pCreateBtn" style="flex:1">Start a Room</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    
    // ============================================================
    // THEME INITIALIZATION
    // ============================================================
    function initTheme() {
      const savedTheme = localStorage.getItem('gutex-theme') || 'default';
      if (savedTheme !== 'default') {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }
    }
    // Apply theme immediately to prevent flash
    initTheme();

    // ============================================================
    // MOBILE DETECTION & HARDENING
    // ============================================================
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
      || (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);

    if (isMobile) {
      document.body.classList.add('is-mobile');
      
      // Prevent context menu on long-press for buttons
      document.addEventListener('contextmenu', function(e) {
        if (e.target.closest('button, a, .results li')) {
          e.preventDefault();
        }
      });

      // Prevent double-tap zoom on interactive elements
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300 && e.target.closest('button, a, input')) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
    }

    // ============================================================
    // LANGUAGE INITIALIZATION
    // ============================================================
    function initLanguage() {
      const savedLang = localStorage.getItem('gutex-language') || 'en';
      const langSelect = document.getElementById('langSelect');
      if (langSelect) langSelect.value = savedLang;
    }
    // Initialize after DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      initLanguage();
      
      // Handle language changes
      var langSelect = document.getElementById('langSelect');
      if (langSelect) {
        langSelect.addEventListener('change', function() {
          localStorage.setItem('gutex-language', this.value);
          // Re-search if there's a query
          var query = document.getElementById('query').value.trim();
          if (query.length >= 2) {
            performSearch(query);
          }
        });
      }
    });
    
    let selectedIndex = -1;
    let currentResults = [];
    
    const SEARCH_CACHE_KEY = 'gutex_last_search';
    const P2P_ROOM_KEY = 'gutex_p2p_room';

    // ============================================================
    // P2P STATE
    // ============================================================
    const p2p = {
      ws: null,
      peerId: null,
      roomId: null,
      displayName: null,
      peers: new Map(),
      reconnectAttempts: 0,
      maxReconnectAttempts: 5,
      reconnectTimeout: null,
      broadcastTimeout: null
    };

    // ============================================================
    // P2P CONNECTION
    // ============================================================
    function initP2PSignaling() {
      if (p2p.ws && p2p.ws.readyState === WebSocket.CONNECTING) return;
      if (p2p.ws && p2p.ws.readyState === WebSocket.OPEN) return;
      
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = protocol + '//' + window.location.host + '/ws/signaling';
      
      try {
        p2p.ws = new WebSocket(wsUrl);
        
        p2p.ws.onopen = function() {
          console.log('[P2P] Connected to signaling server');
          $('p2pStatusDot').classList.add('connected');
          $('p2pStatusText').textContent = 'Connected';
          $('p2pToggle').classList.add('connected');
          p2p.reconnectAttempts = 0;
          
          // Auto-rejoin saved room (only if not already in a room)
          if (!p2p.roomId) {
            var saved = loadSavedRoom();
            if (saved && saved.roomId) {
              p2p.displayName = saved.displayName;
              $('p2pDisplayName').value = saved.displayName || '';
              joinRoom(saved.roomId, saved.displayName);
            }
          }
        };
        
        p2p.ws.onclose = function() {
          console.log('[P2P] Disconnected');
          $('p2pStatusDot').classList.remove('connected');
          $('p2pStatusText').textContent = 'Disconnected';
          $('p2pToggle').classList.remove('connected');
          
          if (p2p.reconnectAttempts < p2p.maxReconnectAttempts) {
            var delay = 3000 * Math.pow(2, p2p.reconnectAttempts);
            p2p.reconnectAttempts++;
            p2p.reconnectTimeout = setTimeout(initP2PSignaling, delay);
          }
        };
        
        p2p.ws.onerror = function() { console.log('[P2P] WebSocket error'); };
        
        p2p.ws.onmessage = function(event) {
          try {
            var message = JSON.parse(event.data);
            handleP2PMessage(message);
          } catch (err) {
            console.error('[P2P] Failed to parse message');
          }
        };
      } catch (err) {
        console.error('[P2P] Failed to create WebSocket');
      }
    }

    function sendP2PMessage(message) {
      if (p2p.ws && p2p.ws.readyState === WebSocket.OPEN) {
        p2p.ws.send(JSON.stringify(message));
      }
    }

    function handleP2PMessage(message) {
      switch (message.type) {
        case 'peer-list':
          if (message.payload && message.payload.yourId) {
            p2p.peerId = message.payload.yourId;
          }
          if (message.payload && message.payload.peers) {
            updatePeerList(message.payload.peers);
          }
          break;
          
        case 'room-info':
          p2p.roomId = message.roomId;
          p2p.peerId = message.peerId;
          if (message.payload && message.payload.room) {
            if (message.payload.room.peers) {
              updatePeerList(message.payload.room.peers);
            }
          }
          // Save room for persistence across pages
          saveRoom(p2p.roomId, p2p.displayName);
          updateRoomUI();
          // Broadcast current state
          broadcastState();
          break;
          
        case 'stream-state':
          handlePeerState(message);
          break;
          
        case 'error':
          console.error('[P2P]', message.payload && message.payload.message);
          // If room not found, recreate it with the saved ID
          if (message.payload && message.payload.message && message.payload.message.includes('not found')) {
            var saved = loadSavedRoom();
            if (saved && saved.roomId) {
              console.log('[P2P] Room ' + saved.roomId + ' expired, recreating...');
              createRoomWithId(saved.roomId, saved.displayName);
            }
          } else {
            showHint(message.payload && message.payload.message || 'P2P Error');
          }
          break;
      }
    }

    var lastPeerRenderTime = 0;
    var PEER_RENDER_THROTTLE_MS = 3000;

    function handlePeerState(message) {
      var peerId = message.peerId;
      var state = message.payload;
      
      if (peerId === p2p.peerId) return;
      
      var now = Date.now();
      if (now - lastPeerRenderTime < PEER_RENDER_THROTTLE_MS) {
        return;
      }
      lastPeerRenderTime = now;

      var peer = p2p.peers.get(peerId);
      var peerName = (peer && peer.displayName) || 'Someone';
      
      var activity = $('peerActivity');
      var header = $('peerActivityName');
      var typing = $('typingIndicator');
      var content = $('peerActivityContent');
      
      if (state.type === 'search') {
        header.textContent = peerName + ' is searching:';
        typing.style.display = state.isTyping ? 'inline-flex' : 'none';
        
        var html = '<div class="search-query">' + escapeHtml(state.query || '(empty)') + '</div>';
        
        if (state.results && state.results.length > 0) {
          html += '<div class="search-results">';
          state.results.slice(0, 5).forEach(function(book) {
            html += '<div class="result-item"><a href="/read#' + book.id + '">#' + book.id + ' ' + escapeHtml(book.title) + '</a></div>';
          });
          if (state.results.length > 5) {
            html += '<div style="padding-top:4px;color:#999;">...and ' + (state.results.length - 5) + ' more</div>';
          }
          html += '</div>';
        }
        content.innerHTML = html;
        activity.classList.add('visible');
        
      } else if (state.type === 'reading' || state.bookId) {
        header.textContent = peerName + ' is reading:';
        typing.style.display = 'none';
        
        content.innerHTML = '<div class="reading-info">' +
          '<div class="book-title">' + escapeHtml(state.bookTitle || 'Book #' + state.bookId) + '</div>' +
          '<div class="progress">' + (state.percent || '0%') + ' ‚Ä¢ ' + (state.mode === '3d' ? '3D mode' : '2D mode') + '</div>' +
          '</div>';
        activity.classList.add('visible');
      }
    }

    // ============================================================
    // ROOM PERSISTENCE
    // ============================================================
    function saveRoom(roomId, displayName) {
      try {
        localStorage.setItem(P2P_ROOM_KEY, JSON.stringify({
          roomId: roomId,
          displayName: displayName,
          timestamp: Date.now()
        }));
      } catch (e) {}
    }

    function loadSavedRoom() {
      try {
        var saved = localStorage.getItem(P2P_ROOM_KEY);
        if (!saved) return null;
        return JSON.parse(saved);
      } catch (e) {
        return null;
      }
    }

    function clearSavedRoom() {
      try {
        localStorage.removeItem(P2P_ROOM_KEY);
      } catch (e) {}
    }

    // ============================================================
    // ROOM UI
    // ============================================================
    function updateRoomUI() {
      var inRoom = !!p2p.roomId;
      
      if (inRoom) {
        document.body.classList.add('in-room');
        $('roomBanner').classList.add('visible');
        $('bannerRoomCode').textContent = p2p.roomId;
        updatePeerCount();
      } else {
        document.body.classList.remove('in-room');
        $('roomBanner').classList.remove('visible');
        $('peerActivity').classList.remove('visible');
      }
    }

    function updatePeerList(peers) {
      p2p.peers.clear();
      peers.forEach(function(peer) {
        p2p.peers.set(peer.id, peer);
      });
      updatePeerCount();
    }

    function updatePeerCount() {
      var count = p2p.peers.size;
      $('bannerPeerCount').textContent = count + (count === 1 ? ' person' : ' people');
    }

    function toggleP2PPanel() {
      $('p2pPanel').classList.toggle('visible');
    }

    function createRoom() {
      var displayName = $('p2pDisplayName').value.trim() || ('User ' + Math.floor(Math.random() * 1000));
      p2p.displayName = displayName;
      
      sendP2PMessage({
        type: 'create-room',
        payload: {
          displayName: displayName,
          name: displayName + "'s Room"
        }
      });
      
      $('p2pPanel').classList.remove('visible');
    }

    function createRoomWithId(roomId, displayName) {
      displayName = displayName || $('p2pDisplayName').value.trim() || ('User ' + Math.floor(Math.random() * 1000));
      p2p.displayName = displayName;
      
      sendP2PMessage({
        type: 'create-room',
        payload: {
          roomId: roomId,
          displayName: displayName,
          name: displayName + "'s Room"
        }
      });
      
      console.log('[P2P] Recreating room ' + roomId + ' as "' + displayName + '"');
    }

    function joinRoom(roomCode, displayName) {
      roomCode = (roomCode || '').trim().toUpperCase();
      displayName = displayName || $('p2pDisplayName').value.trim() || ('User ' + Math.floor(Math.random() * 1000));
      p2p.displayName = displayName;
      
      if (!roomCode || roomCode.length < 4) {
        showHint('Enter a valid room code');
        return;
      }
      
      sendP2PMessage({
        type: 'join-room',
        roomId: roomCode,
        payload: { displayName: displayName }
      });
      
      $('p2pPanel').classList.remove('visible');
    }

    function leaveRoom() {
      sendP2PMessage({ type: 'leave-room' });
      p2p.roomId = null;
      p2p.peers.clear();
      clearSavedRoom();
      updateRoomUI();
    }

    function copyRoomCode() {
      navigator.clipboard.writeText(p2p.roomId).then(function() {
        var btn = $('bannerCopyBtn');
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
      });
    }

    // ============================================================
    // BROADCAST STATE
    // ============================================================
    var isTyping = false;
    var typingTimeout = null;

    function broadcastState(forceTyping) {
      if (!p2p.roomId) return;
      
      if (p2p.broadcastTimeout) {
        clearTimeout(p2p.broadcastTimeout);
      }
      
      p2p.broadcastTimeout = setTimeout(function() {
        sendP2PMessage({
          type: 'stream-state',
          payload: {
            type: 'search',
            query: $('query').value,
            results: currentResults.slice(0, 10),
            isTyping: forceTyping || isTyping,
            timestamp: Date.now()
          }
        });
      }, 50);
    }

    function setTyping(typing) {
      isTyping = typing;
      
      if (typingTimeout) clearTimeout(typingTimeout);
      
      if (typing) {
        typingTimeout = setTimeout(function() {
          isTyping = false;
          broadcastState();
        }, 2000);
      }
      
      broadcastState(typing);
    }

    // ============================================================
    // SEARCH FUNCTIONALITY
    // ============================================================
    function saveSearchCache(query, results) {
      try {
        localStorage.setItem(SEARCH_CACHE_KEY, JSON.stringify({ query: query, results: results }));
      } catch (e) {}
    }

    function loadSearchCache() {
      try {
        var cached = localStorage.getItem(SEARCH_CACHE_KEY);
        return cached ? JSON.parse(cached) : null;
      } catch (e) {
        return null;
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function formatAuthor(author) {
      return author
        .replace(/,\s*\d{4}-\d{4}/g, '')
        .replace(/,\s*\d{4}-/g, '')
        .replace(/,\s*-\d{4}/g, '')
        .replace(/\s*\[.*?\]/g, '')
        .split('; ')
        .map(function(name) { return name.split(', ').reverse().join(' ').trim(); })
        .join(', ');
    }

    function renderResults(results, query) {
      currentResults = results;
      $('status').textContent = results.length + ' result' + (results.length !== 1 ? 's' : '') + ' for "' + query + '" ‚Äî ‚Üë‚Üì to navigate, Enter to select';
      
      $('results').innerHTML = results.map(function(book) {
        var author = book.author ? formatAuthor(book.author) : null;
        return '<li>' +
          '<a href="/read#' + book.id + '">' +
            '<span class="book-id">#' + book.id + '</span>' +
            '<span class="book-title">' + escapeHtml(book.title) + '</span>' +
            (author ? '<span class="book-author"> ‚Äî ' + escapeHtml(author) + '</span>' : '') +
          '</a>' +
        '</li>';
      }).join('');
      
      broadcastState();
    }
    
    function updateSelection() {
      var items = $('results').querySelectorAll('li');
      items.forEach(function(item, i) {
        item.classList.toggle('selected', i === selectedIndex);
      });
      
      if (selectedIndex >= 0 && items[selectedIndex]) {
        items[selectedIndex].scrollIntoView({ block: 'nearest' });
      }
    }
    
    async function search(query) {
      if (!query || query.length < 2) {
        $('status').textContent = 'Enter at least 2 characters';
        $('results').innerHTML = '';
        currentResults = [];
        selectedIndex = -1;
        broadcastState();
        return;
      }
      
      $('status').textContent = 'Searching...';
      $('results').innerHTML = '';
      currentResults = [];
      selectedIndex = -1;
      
      try {
        var langSelect = $('langSelect');
        var lang = langSelect ? langSelect.value : (localStorage.getItem('gutex-language') || 'en');
        var res = await fetch('/api/search?q=' + encodeURIComponent(query) + '&lang=' + encodeURIComponent(lang));
        var data = await res.json();
        
        if (data.error) {
          $('status').textContent = data.error;
          broadcastState();
          return;
        }
        
        if (data.results.length === 0) {
          $('status').textContent = 'No results for "' + query + '"';
          broadcastState();
          return;
        }
        
        renderResults(data.results, query);
        saveSearchCache(query, data.results);
        
      } catch (err) {
        $('status').textContent = 'Error: ' + err.message;
        broadcastState();
      }
    }

    function showHint(message) {
      var existing = document.querySelector('.hint-toast');
      if (existing) existing.remove();
      
      var hint = document.createElement('div');
      hint.className = 'hint-toast';
      hint.textContent = message;
      document.body.appendChild(hint);
      
      setTimeout(function() { hint.remove(); }, 3000);
    }
    
    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    $('searchBtn').addEventListener('click', function() {
      setTyping(false);
      search($('query').value);
    });
    
    $('query').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        setTyping(false);
        if (selectedIndex >= 0 && currentResults[selectedIndex]) {
          window.location.href = '/read#' + currentResults[selectedIndex].id;
        } else {
          search($('query').value);
        }
        return;
      }
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentResults.length > 0) {
          selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
          updateSelection();
        }
        return;
      }
      
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentResults.length > 0) {
          selectedIndex = Math.max(selectedIndex - 1, -1);
          updateSelection();
        }
        return;
      }
    });
    
    var searchTimeout;
    $('query').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      selectedIndex = -1;
      var query = $('query').value;
      
      setTyping(true);
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(function() {
          setTyping(false);
          search(query);
        }, 300);
      } else {
        $('status').textContent = '';
        $('results').innerHTML = '';
        currentResults = [];
        broadcastState();
      }
    });

    // P2P event listeners
    $('p2pToggle').addEventListener('click', toggleP2PPanel);
    $('p2pClose').addEventListener('click', function() { $('p2pPanel').classList.remove('visible'); });
    $('p2pCreateBtn').addEventListener('click', createRoom);
    $('p2pJoinBtn').addEventListener('click', function() { joinRoom($('p2pRoomCodeInput').value); });
    $('p2pRoomCodeInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') joinRoom($('p2pRoomCodeInput').value);
    });
    
    // Banner buttons
    $('bannerCopyBtn').addEventListener('click', copyRoomCode);
    $('bannerLeaveBtn').addEventListener('click', leaveRoom);

    // ============================================================
    // INITIALIZATION
    // ============================================================
    // Restore last search
    var cached = loadSearchCache();
    if (cached && cached.results && cached.results.length > 0) {
      $('query').value = cached.query || '';
      renderResults(cached.results, cached.query);
    }

    // Restore display name
    var saved = loadSavedRoom();
    if (saved && saved.displayName) {
      $('p2pDisplayName').value = saved.displayName;
    }

    // Initialize P2P
    initP2PSignaling();
  </script>

  <footer class="site-footer">
    <a href="https://github.com/petethomas/gutex" target="_blank" rel="noopener" title="View on GitHub"><svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a>
  </footer>
</body>
</html>
